# Delivery Service Documentation

## Responsibilities
- Delivery partner management
- Delivery tracking, shifts, and incentives
- Zone and transporter management
- Salary and earnings management
- Document verification
- Settlement processing
- Slot management
- In-app messaging system

## Database (PostgreSQL)

### Core Tables
- `transporters`
- `transporter_documents`
- `transporter_locations`
- `transporter_password_resets`
- `transporter_shifts`
- `transporter_shift_timings`
- `transporter_vehicles`
- `qwqer_transporters`
- `qwqer_order_assigns`
- `qwqer_zones`
- `zone_transporter_incentives`
- `zones`

### New Tables
- `transporter_earnings`
  - `id`
  - `transporter_id`
  - `base_earnings`
  - `surge_charge`
  - `tip_amount`
  - `total_earnings`
  - `date`
  - `created_at`
  - `updated_at`

- `transporter_incentives`
  - `id`
  - `transporter_id`
  - `type` (percentage_based, delivery_count, welcome_bonus, target_based)
  - `amount`
  - `target_value` (for target-based incentives)
  - `status` (pending, approved, paid)
  - `created_at`
  - `updated_at`

- `transporter_documents`
  - `id`
  - `transporter_id`
  - `document_type` (driving_license, aadhar_card, pan_card, photo)
  - `document_number`
  - `document_url`
  - `verification_status`
  - `expiry_date`
  - `created_at`
  - `updated_at`

- `transporter_settlements`
  - `id`
  - `transporter_id`
  - `amount`
  - `settlement_type` (full, partial)
  - `status` (pending, completed, failed)
  - `settlement_date`
  - `created_at`
  - `updated_at`

- `delivery_slots`
  - `id`
  - `zone_id`
  - `start_time`
  - `end_time`
  - `max_rides`
  - `max_riders`
  - `current_rides`
  - `current_riders`
  - `status` (active, inactive)
  - `created_at`
  - `updated_at`

- `slot_reservations`
  - `id`
  - `slot_id`
  - `transporter_id`
  - `attendance_status`
  - `reservation_status`
  - `created_at`
  - `updated_at`

- `first_mile_earnings`
  - `id`
  - `transporter_id`
  - `order_id`
  - `distance_to_shop`
  - `distance_shop_to_customer`
  - `earnings_amount`
  - `created_at`
  - `updated_at`

- `in_app_messages`
  - `id`
  - `sender_id`
  - `receiver_id`
  - `message_type` (text, image, location)
  - `content`
  - `read_status`
  - `created_at`
  - `updated_at`

## Technologies
- Python 3.9+
- FastAPI
- PostgreSQL
- Alembic (migrations)
- Redis (pub/sub, caching)
- WebSocket (for real-time messaging)
- Docker, Kubernetes
- Google Maps API (for distance calculations)
- Celery (for settlement processing)

## Features

### Salary Management
- Base earnings calculation
- Surge charge integration
- Tip collection and distribution
- Daily/weekly/monthly earnings reports

### Incentive System
- Percentage-based incentives on earnings
- Delivery count-based incentives
- Welcome bonus for new transporters
- Target-based incentives:
  - Number of deliveries completed
  - Earnings targets
  - Weekly attendance
  - Full-time participation
  - Half-time participation

### Document Management
- Document upload and verification
- Required documents:
  - Driving license
  - Aadhar card
  - PAN card
  - Photo
- Document expiry tracking
- Verification status management

### Settlement System
- Configurable cash-in-hand limits per transporter
- Partial amount settlement support
- Settlement history (60-day retention policy)
- Automated settlement processing
- Settlement status tracking

### Slot Management
- Ride limits per slot
- Rider limits per slot
- Slot reservation system
- Attendance-based slot allocation
- Real-time slot availability updates

### First Mile Earnings
- Distance calculation from rider's location to shop
- Distance calculation from shop to customer
- Earnings calculation based on total distance
- Integration with Google Maps API

### In-App Messaging
- Real-time messaging between:
  - Admin and transporters
  - Transporter and customer
  - Transporter and shop
- Message types:
  - Text
  - Images
  - Location sharing
- Message status tracking
- Message history

## Inter-Service Communication
- RESTful APIs (FastAPI)
- WebSocket for real-time messaging
- Publishes delivery events (e.g., delivery assigned) to RabbitMQ/Kafka
- Receives order events from Order Service
- Receives requests from API Gateway
- Integrates with Payment Service for settlements
- Integrates with Notification Service for alerts

## API Documentation
- Swagger UI auto-generated by FastAPI
- WebSocket documentation
- Event documentation

## Notes
- No direct access to other service databases
- Settlement history automatically purged after 60 days
- Real-time location tracking requires WebSocket connection
- Document verification requires manual review process
- Slot management requires real-time updates 